{% load static %}
<div class="container mx-auto px-4 py-10">

        <h1 class="text-3xl font-bold mb-2 py-4 px-1">Explore Gunung</h1>
        <input type="text" 
               id="search-input" 
               placeholder="Cari berdasarkan nama atau provinsi..." 
               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
               onkeyup="getGunungData()">
        <div id="gunung-list" class="mt-3 mb-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div class="text-center mt-6">
        <button id="show-more-btn"
                class="hidden px-6 py-3 bg-[#2a3c24] text-white rounded-lg hover:scale-105 transform overflow-hidden transition duration-300">
            Show More
        </button>
        </div>
</div>
<script>
    let currentPage = 1;
    const limit = 6;
    let hasMore = true;
    let isLoading = false;

    const gunungListDiv = document.getElementById('gunung-list');
    const searchInput = document.getElementById('search-input');
    const showMoreBtn = document.getElementById('show-more-btn');
    const nomountainurl = "{% static 'image/no-mountain.png' %}";

    function createGunungCard(gunung) {
        return `
            <div class="bg-[#2a3c24] rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transform overflow-hidden transition duration-300">
                <img src="${gunung.foto || 'https://via.placeholder.com/400x200?text=No+Image'}" 
                     alt="${gunung.nama}" 
                     class="w-full h-48 object-cover">
                <div class="p-4">
                    <a href="/gunung/${gunung.id}/" class="text-xl font-semibold text-white">${gunung.nama}</a>
                    <p class="text-sm text-gray-100 mb-2">
                        ${gunung.provinsi} | ${gunung.ketinggian} mdpl
                    </p>
                    <p class="text-[#cad593] line-clamp-3">${gunung.deskripsi}</p>
                    <a href="/gunung/${gunung.id}/" class="text-white hover:text-green-400 mt-3 inline-block">Detail</a>
                </div>
            </div>
        `;
    }

    function getGunungData(isNewSearch = false) {
        if (isLoading || (!hasMore && !isNewSearch)) return;

        if (isNewSearch) {
            currentPage = 1;
            hasMore = true;
            gunungListDiv.innerHTML = '';
        }

        isLoading = true;

        const searchQuery = searchInput.value;
        const url = `/json/?q=${encodeURIComponent(searchQuery)}&page=${currentPage}&limit=${limit}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.results.length === 0 && currentPage === 1) {
                    gunungListDiv.innerHTML = `
                        <div class="bg-white rounded-lg p-12 text-center col-span-full">
                            <div class="h-48 mx-auto mb-4">
                                <img src="${nomountainurl}" alt="No mountain available" class="w-full h-full object-contain">
                            </div>
                        </div>`;
                    showMoreBtn.classList.add('hidden');
                } else {
                    data.results.forEach(gunung => {
                        gunungListDiv.innerHTML += createGunungCard(gunung);
                    });

                    hasMore = data.has_more;
                    if (hasMore) {
                        showMoreBtn.classList.remove('hidden');
                        currentPage++;
                    } else {
                        showMoreBtn.classList.add('hidden');
                    }
                }

                isLoading = false;
            })
            .catch(error => {
                console.error('Error:', error);
                isLoading = false;
            });
    }


    // Event: pertama kali load
    document.addEventListener('DOMContentLoaded', () => {
        getGunungData();
    });

    // Event: tombol "Show More"
    showMoreBtn.addEventListener('click', () => {
        getGunungData();
    });

    // Event: pencarian baru (pakai debounce biar gak spam fetch)
    let typingTimer;
    searchInput.addEventListener('keyup', () => {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            getGunungData(true);
        }, 400); // 0.4 detik setelah berhenti ngetik
    });
</script>
